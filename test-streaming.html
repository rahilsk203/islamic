<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IslamicAI Streaming Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .response-area {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            min-height: 100px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        button {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success { background: rgba(46, 204, 113, 0.3); }
        .status.error { background: rgba(231, 76, 60, 0.3); }
        .status.info { background: rgba(52, 152, 219, 0.3); }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo {
            font-size: 48px;
            margin-bottom: 10px;
        }
        input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            margin: 10px 0;
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .streaming-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #2ecc71;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            margin-left: 10px;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üïå</div>
            <h1>IslamicAI Frontend Streaming Test</h1>
            <p>Testing streaming responses from the updated frontend</p>
        </div>

        <div class="test-section">
            <h3>üîó Backend Connection Test</h3>
            <button onclick="testConnection()">Test Backend Connection</button>
            <div id="connectionStatus" class="status"></div>
        </div>

        <div class="test-section">
            <h3>üì° Streaming Response Test</h3>
            <input type="text" id="messageInput" placeholder="Ask an Islamic question..." value="What are the five pillars of Islam?">
            <button onclick="testStreaming()" id="streamBtn">Send Streaming Message</button>
            <div id="streamingStatus" class="status"></div>
            <div id="streamingResponse" class="response-area"></div>
        </div>

        <div class="test-section">
            <h3>üìÑ Direct Response Test</h3>
            <button onclick="testDirect()">Send Direct Message</button>
            <div id="directStatus" class="status"></div>
            <div id="directResponse" class="response-area"></div>
        </div>

        <div class="test-section">
            <h3>üîç Frontend API Test</h3>
            <button onclick="testFrontendAPI()">Test Frontend API Integration</button>
            <div id="frontendStatus" class="status"></div>
            <div id="frontendResponse" class="response-area"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8787';
        let sessionId = 'test_session_' + Date.now();

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function updateResponse(elementId, content, append = false) {
            const element = document.getElementById(elementId);
            if (append) {
                element.textContent += content;
            } else {
                element.textContent = content;
            }
        }

        async function testConnection() {
            updateStatus('connectionStatus', 'Testing connection...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    const data = await response.json();
                    updateStatus('connectionStatus', `‚úÖ Backend connected: ${data.status} - ${data.message}`, 'success');
                } else {
                    updateStatus('connectionStatus', `‚ùå Backend error: ${response.status}`, 'error');
                }
            } catch (error) {
                updateStatus('connectionStatus', `‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        async function testStreaming() {
            const message = document.getElementById('messageInput').value || "What are the five pillars of Islam?";
            const streamBtn = document.getElementById('streamBtn');
            
            streamBtn.disabled = true;
            streamBtn.innerHTML = 'üì° Streaming... <span class="streaming-indicator"></span>';
            
            updateStatus('streamingStatus', 'Starting streaming request...', 'info');
            updateResponse('streamingResponse', '');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId,
                        language_info: {
                            detected_language: 'english',
                            confidence: 0.9,
                            should_respond_in_language: true
                        },
                        streaming_options: {
                            enableStreaming: true,
                            chunkSize: 30,
                            delay: 50,
                            includeMetadata: true
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('text/event-stream')) {
                    updateStatus('streamingStatus', '‚úÖ Streaming response detected', 'success');
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullResponse = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) {
                            updateStatus('streamingStatus', `‚úÖ Streaming completed (${fullResponse.length} chars)`, 'success');
                            break;
                        }
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const chunkData = JSON.parse(line.substring(6));
                                    
                                    if (chunkData.type === 'content' && chunkData.content) {
                                        fullResponse += chunkData.content;
                                        updateResponse('streamingResponse', fullResponse);
                                    }
                                } catch (parseError) {
                                    console.warn('Failed to parse chunk:', line);
                                }
                            }
                        }
                    }
                } else {
                    const data = await response.json();
                    updateStatus('streamingStatus', 'üìÑ Direct response received instead', 'info');
                    updateResponse('streamingResponse', data.reply || 'No response content');
                }
                
            } catch (error) {
                updateStatus('streamingStatus', `‚ùå Streaming failed: ${error.message}`, 'error');
                updateResponse('streamingResponse', `Error: ${error.message}`);
            } finally {
                streamBtn.disabled = false;
                streamBtn.innerHTML = 'Send Streaming Message';
            }
        }

        async function testDirect() {
            updateStatus('directStatus', 'Sending direct request...', 'info');
            updateResponse('directResponse', '');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: "Tell me about Islamic prayer",
                        session_id: sessionId,
                        language_info: {
                            detected_language: 'english',
                            confidence: 0.9,
                            should_respond_in_language: true
                        },
                        streaming_options: {
                            enableStreaming: false
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();
                updateStatus('directStatus', '‚úÖ Direct response received', 'success');
                updateResponse('directResponse', data.reply || 'No response content');
                
            } catch (error) {
                updateStatus('directStatus', `‚ùå Direct request failed: ${error.message}`, 'error');
                updateResponse('directResponse', `Error: ${error.message}`);
            }
        }

        async function testFrontendAPI() {
            updateStatus('frontendStatus', 'Testing frontend API integration...', 'info');
            updateResponse('frontendResponse', '');
            
            try {
                // Simulate what the frontend would do
                const message = "What is the meaning of Bismillah?";
                let fullResponse = '';
                
                // Mock streaming callback functions like the frontend uses
                const streamingCallbacks = {
                    onStreamStart: () => {
                        updateResponse('frontendResponse', 'IslamicAI is thinking...\\n');
                    },
                    onStreamChunk: (chunk, fullContent, chunkData) => {
                        fullResponse = fullContent;
                        updateResponse('frontendResponse', `Streaming: ${fullContent}`);
                    },
                    onStreamEnd: (finalContent) => {
                        updateResponse('frontendResponse', `Final: ${finalContent}`);
                        updateStatus('frontendStatus', '‚úÖ Frontend API test completed', 'success');
                    },
                    onStreamError: (error) => {
                        updateStatus('frontendStatus', `‚ùå Frontend API error: ${error}`, 'error');
                        updateResponse('frontendResponse', `Error: ${error}`);
                    }
                };
                
                // Call the actual streaming function
                const response = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId,
                        language_info: {
                            detected_language: 'english',
                            confidence: 0.9,
                            should_respond_in_language: true
                        },
                        streaming_options: {
                            enableStreaming: true,
                            chunkSize: 30,
                            delay: 50,
                            includeMetadata: true
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('text/event-stream')) {
                    streamingCallbacks.onStreamStart();
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    fullResponse = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) {
                            streamingCallbacks.onStreamEnd(fullResponse);
                            break;
                        }
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const chunkData = JSON.parse(line.substring(6));
                                    
                                    if (chunkData.type === 'content' && chunkData.content) {
                                        fullResponse += chunkData.content;
                                        streamingCallbacks.onStreamChunk(chunkData.content, fullResponse, chunkData);
                                    }
                                } catch (parseError) {
                                    console.warn('Failed to parse chunk:', line);
                                }
                            }
                        }
                    }
                } else {
                    const data = await response.json();
                    updateResponse('frontendResponse', data.reply || 'No response content');
                    updateStatus('frontendStatus', 'üìÑ Direct response (not streaming)', 'info');
                }
                
            } catch (error) {
                updateStatus('frontendStatus', `‚ùå Frontend API test failed: ${error.message}`, 'error');
                updateResponse('frontendResponse', `Error: ${error.message}`);
            }
        }

        // Auto-test connection on page load
        window.onload = function() {
            setTimeout(testConnection, 1000);
        };
    </script>
</body>
</html>